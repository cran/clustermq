<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>User Guide</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">User Guide</h1>



<style type="text/css">
img {
border: 0px !important;
margin: 2em 2em 2em 2em !important;
}
code {
border: 0px !important;
}
</style>
<div id="installation" class="section level2">
<h2>Installation</h2>
<p>Install the <code>clustermq</code> package in R from CRAN. This will
automatically detect if <a href="https://github.com/zeromq/libzmq">ZeroMQ</a> is installed and
otherwise use the bundled library:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># Recommended:</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="co">#   If your system has `libzmq` installed but you want to enable the worker</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="co">#   crash monitor, set the environment variable below to use the bundled</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="co">#   `libzmq` library with the required feature (`-DZMQ_BUILD_DRAFT_API=1`):</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="co"># Sys.setenv(CLUSTERMQ_USE_SYSTEM_LIBZMQ=0)</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;clustermq&quot;</span>)</span></code></pre></div>
<p>Alternatively you can use the <code>remotes</code> package to install
directly from Github. Note that this version needs
<code>autoconf</code>/<code>automake</code> and <code>CMake</code> for
compilation:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Sys.setenv(CLUSTERMQ_USE_SYSTEM_LIBZMQ=0)</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="co"># install.packages(&#39;remotes&#39;)</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;mschubert/clustermq&quot;</span>)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co"># remotes::install_github(&quot;mschubert/clustermq@develop&quot;) # dev version</span></span></code></pre></div>
<p>In the <a href="https://github.com/mschubert/clustermq/tree/develop"><code>develop</code></a>
branch, we will introduce code changes and new features. These may
contain bugs, poor documentation, or other inconveniences. This branch
may not install at times. However, <a href="https://github.com/mschubert/clustermq/issues/new">feedback is
very welcome</a>.</p>
<p>For any installation issues please see the <a href="https://mschubert.github.io/clustermq/articles/faq.html">FAQ</a>.</p>
</div>
<div id="configuration" class="section level2">
<h2>Configuration</h2>
<p>An HPC cluster’s scheduler ensures that computing jobs are
distributed to available worker nodes. Hence, this is what
<code>clustermq</code> interfaces with in order to do computations.</p>
<p>By default, we will take whichever scheduler we find and fall back on
local processing. This will work in most, but not all cases. You may
need to configure your scheduler.</p>
<div id="scheduler-setup" class="section level3">
<h3>Setting up the scheduler</h3>
<p>To set up a scheduler explicitly, see the following links:</p>
<ul>
<li><a href="#slurm">SLURM</a> - <em>should work without setup</em></li>
<li><a href="#lsf">LSF</a> - <em>should work without setup</em></li>
<li><a href="#sge">SGE</a> - <em>may require configuration</em></li>
<li><a href="#pbs">PBS</a>/<a href="#torque">Torque</a> - <em>needs</em>
<code>options(clustermq.scheduler=&quot;PBS&quot;/&quot;Torque&quot;)</code></li>
<li>you can suggest another scheduler by <a href="https://github.com/mschubert/clustermq/issues">opening an
issue</a></li>
</ul>
<p>You may in addition need to activate <a href="#environments">compute
environments or containers</a> if your shell (<em>e.g.</em>
<code>~/.bashrc</code>) does not do this automatically.</p>
<p>Check the <a href="https://mschubert.github.io/clustermq/articles/faq.html">FAQ</a>
if your job submission/call to <code>Q</code> errors or gets stuck.</p>
</div>
<div id="local-parallelization" class="section level3">
<h3>Local parallelization</h3>
<p>While this is not the main focus of the package, you can use it to
parallelize function calls locally on multiple cores or processes. This
can also be useful to test your code on a subset of the data before
submitting it to a scheduler.</p>
<ul>
<li>Multiprocess (<em>recommended</em>) - Use the <code>callr</code>
package to run and manage multiple parallel R processes with
<code>options(clustermq.scheduler=&quot;multiprocess&quot;)</code></li>
<li>Multicore - Uses the <code>parallel</code> package to fork the
current R process into multiple threads with
<code>options(clustermq.scheduler=&quot;multicore&quot;)</code>. This sometimes
causes problems (macOS, RStudio) and is not available on Windows.</li>
</ul>
</div>
<div id="ssh-connector" class="section level3">
<h3>SSH connector</h3>
<p>There are reasons why you might prefer to not to work on the
computing cluster directly but rather on your local machine instead. <a href="https://posit.co/products/open-source/rstudio/">RStudio</a> is an
excellent local IDE, it’s more responsive than and feature-rich than
browser-based solutions (<a href="https://posit.co/products/open-source/rstudio-server/">RStudio
server</a>, <a href="https://jupyter.org/">Project Jupyter</a>), and it
avoids X forwarding issues when you want to look at plots you just
made.</p>
<p>Using this setup, however, you lost access to the computing cluster.
Instead, you had to copy your data there, and then submit individual
scripts as jobs, aggregating the data in the end again.
<code>clustermq</code> is trying to solve this by providing a
transparent SSH interface.</p>
<p>In order to use <code>clustermq</code> from your local machine, the
package needs to be installed on both there and on the computing
cluster. On the computing cluster, <a href="#scheduler-setup">set up
your scheduler</a> and make sure <code>clustermq</code> runs there
without problems. Note that the <em>remote scheduler</em> can not be
<code>LOCAL</code> (default if no HPC scheduler found) or
<code>SSH</code> for this to work.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># If this is set to &#39;LOCAL&#39; or &#39;SSH&#39; you will get the following error:</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co">#  Expected PROXY_READY, received ‘PROXY_ERROR: Remote SSH QSys is not allowed’</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="fu">options</span>(</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    <span class="at">clustermq.scheduler =</span> <span class="st">&quot;multiprocess&quot;</span> <span class="co"># or multicore, LSF, SGE, Slurm etc.</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>)</span></code></pre></div>
<p>On your <em>local machine</em>, add the following options:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">options</span>(</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    <span class="at">clustermq.scheduler =</span> <span class="st">&quot;ssh&quot;</span>,</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="at">clustermq.ssh.host =</span> <span class="st">&quot;user@host&quot;</span>, <span class="co"># use your user and host, obviously</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    <span class="at">clustermq.ssh.log =</span> <span class="st">&quot;~/cmq_ssh.log&quot;</span> <span class="co"># log for easier debugging</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>)</span></code></pre></div>
<p>We recommend that you <a href="https://www.digitalocean.com/community/tutorials/how-to-configure-ssh-key-based-authentication-on-a-linux-server">set
up SSH keys</a> for password-less login.</p>
</div>
</div>
<div id="usage" class="section level2">
<h2>Usage</h2>
<div id="the-q-function" class="section level3">
<h3>The <code>Q</code> function</h3>
<p>The following arguments are supported by <code>Q</code>:</p>
<ul>
<li><code>fun</code> - The function to call. This needs to be
self-sufficient (because it will not have access to the
<code>master</code> environment)</li>
<li><code>...</code> - All iterated arguments passed to the function. If
there is more than one, all of them need to be named</li>
<li><code>const</code> - A named list of non-iterated arguments passed
to <code>fun</code></li>
<li><code>export</code> - A named list of objects to export to the
worker environment</li>
</ul>
<p>Behavior can further be fine-tuned using the options below:</p>
<ul>
<li><code>fail_on_error</code> - Whether to stop if one of the calls
returns an error</li>
<li><code>seed</code> - A common seed that is combined with job number
for reproducible results</li>
<li><code>memory</code> - Amount of memory to request for the job
(<code>bsub -M</code>)</li>
<li><code>n_jobs</code> - Number of jobs to submit for all the function
calls</li>
<li><code>job_size</code> - Number of function calls per job. If used in
combination with <code>n_jobs</code> the latter will be overall
limit</li>
<li><code>chunk_size</code> - How many calls a worker should process
before reporting back to the master. Default: every worker will report
back 100 times total</li>
</ul>
<p>The full documentation is available by typing <code>?Q</code>.</p>
</div>
<div id="examples" class="section level3">
<h3>Examples</h3>
<p>The package is designed to distribute arbitrary function calls on HPC
worker nodes. There are, however, a couple of caveats to observe as the
R session running on a worker does not share your local memory.</p>
<p>The simplest example is to a function call that is completely
self-sufficient, and there is one argument (<code>x</code>) that we
iterate through:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>fx <span class="ot">=</span> <span class="cf">function</span>(x) x <span class="sc">*</span> <span class="dv">2</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="fu">Q</span>(fx, <span class="at">x=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">n_jobs=</span><span class="dv">1</span>)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co">#&gt; Running sequentially (&#39;LOCAL&#39;) ...</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">#&gt; [[1]]</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co">#&gt; [1] 2</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co">#&gt; [[2]]</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="co">#&gt; [1] 4</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="co">#&gt; [[3]]</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="co">#&gt; [1] 6</span></span></code></pre></div>
<p>Non-iterated arguments are supported by the <code>const</code>
argument:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>fx <span class="ot">=</span> <span class="cf">function</span>(x, y) x <span class="sc">*</span> <span class="dv">2</span> <span class="sc">+</span> y</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="fu">Q</span>(fx, <span class="at">x=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">const=</span><span class="fu">list</span>(<span class="at">y=</span><span class="dv">10</span>), <span class="at">n_jobs=</span><span class="dv">1</span>)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co">#&gt; Running sequentially (&#39;LOCAL&#39;) ...</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co">#&gt; [[1]]</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co">#&gt; [1] 12</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co">#&gt; [[2]]</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co">#&gt; [1] 14</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="co">#&gt; [[3]]</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="co">#&gt; [1] 16</span></span></code></pre></div>
<p>If a function relies on objects in its environment that are not
passed as arguments (including other functions), they can be exported
using the <code>export</code> argument:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>fx <span class="ot">=</span> <span class="cf">function</span>(x) x <span class="sc">*</span> <span class="dv">2</span> <span class="sc">+</span> y</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="fu">Q</span>(fx, <span class="at">x=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">export=</span><span class="fu">list</span>(<span class="at">y=</span><span class="dv">10</span>), <span class="at">n_jobs=</span><span class="dv">1</span>)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="co">#&gt; Running sequentially (&#39;LOCAL&#39;) ...</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="co">#&gt; [[1]]</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="co">#&gt; [1] 12</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="co">#&gt; [[2]]</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="co">#&gt; [1] 14</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="co">#&gt; [[3]]</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="co">#&gt; [1] 16</span></span></code></pre></div>
<p>If we want to use a package function we need to load it on the worker
using the <code>pkgs</code> parameter, or referencing it with
<code>package_name::</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>f1 <span class="ot">=</span> <span class="cf">function</span>(x) <span class="fu">splitIndices</span>(x, <span class="dv">3</span>)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="fu">Q</span>(f1, <span class="at">x=</span><span class="dv">3</span>, <span class="at">n_jobs=</span><span class="dv">1</span>, <span class="at">pkgs=</span><span class="st">&quot;parallel&quot;</span>)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co">#&gt; Running sequentially (&#39;LOCAL&#39;) ...</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="co">#&gt; [[1]]</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="co">#&gt; [[1]][[1]]</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="co">#&gt; [1] 1</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="co">#&gt; [[1]][[2]]</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="co">#&gt; [1] 2</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a><span class="co">#&gt; [[1]][[3]]</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a><span class="co">#&gt; [1] 3</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>f2 <span class="ot">=</span> <span class="cf">function</span>(x) parallel<span class="sc">::</span><span class="fu">splitIndices</span>(x, <span class="dv">3</span>)</span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a><span class="fu">Q</span>(f2, <span class="at">x=</span><span class="dv">8</span>, <span class="at">n_jobs=</span><span class="dv">1</span>)</span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a><span class="co">#&gt; Running sequentially (&#39;LOCAL&#39;) ...</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a><span class="co">#&gt; [[1]]</span></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a><span class="co">#&gt; [[1]][[1]]</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a><span class="co">#&gt; [1] 1 2 3</span></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a><span class="co">#&gt; [[1]][[2]]</span></span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a><span class="co">#&gt; [1] 4 5</span></span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a><span class="co">#&gt; [[1]][[3]]</span></span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a><span class="co">#&gt; [1] 6 7 8</span></span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a><span class="co"># Q(f1, x=5, n_jobs=1)</span></span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a><span class="co"># (Error #1) could not find function &quot;splitIndices&quot;</span></span></code></pre></div>
</div>
<div id="as-parallel-foreach-backend" class="section level3">
<h3>As parallel <code>foreach</code> backend</h3>
<p>The <a href="https://cran.r-project.org/package=foreach"><code>foreach</code></a>
package provides an interface to perform repeated tasks on different
backends. While it can perform the function of simple loops using
<code>%do%</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">i=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">%do%</span> <span class="fu">sqrt</span>(i)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="co">#&gt; [[1]]</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co">#&gt; [1] 1</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="co">#&gt; [[2]]</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="co">#&gt; [1] 1.414214</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="co">#&gt; [[3]]</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="co">#&gt; [1] 1.732051</span></span></code></pre></div>
<p>it can also perform these operations in parallel using
<code>%dopar%</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">i=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">%dopar%</span> <span class="fu">sqrt</span>(i)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="co">#&gt; Warning: executing %dopar% sequentially: no parallel backend registered</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="co">#&gt; [[1]]</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co">#&gt; [1] 1</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="co">#&gt; [[2]]</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="co">#&gt; [1] 1.414214</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="co">#&gt; [[3]]</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="co">#&gt; [1] 1.732051</span></span></code></pre></div>
<p>The latter allows registering different handlers for parallel
execution, where we can use <code>clustermq</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># set up the scheduler first, otherwise this will run sequentially</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="co"># this accepts same arguments as `Q`</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="co"># the number of jobs is ignored here since we&#39;re using the LOCAL scheduler</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>clustermq<span class="sc">::</span><span class="fu">register_dopar_cmq</span>(<span class="at">n_jobs=</span><span class="dv">2</span>, <span class="at">memory=</span><span class="dv">1024</span>)</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="co"># this will be executed as jobs</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">i=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">%dopar%</span> <span class="fu">sqrt</span>(i)</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="co">#&gt; Running sequentially (&#39;LOCAL&#39;) ...</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="co">#&gt; [[1]]</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="co">#&gt; [1] 1</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="co">#&gt; [[2]]</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="co">#&gt; [1] 1.414214</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a><span class="co">#&gt; [[3]]</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a><span class="co">#&gt; [1] 1.732051</span></span></code></pre></div>
<p>As <a href="https://bioconductor.org/packages/release/bioc/html/BiocParallel.html">BiocParallel</a>
supports <code>foreach</code> too, this means we can run all packages
that use <code>BiocParallel</code> on the cluster as well via
<code>DoparParam</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">library</span>(BiocParallel)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="co"># the number of jobs is ignored here since we&#39;re using the LOCAL scheduler</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>clustermq<span class="sc">::</span><span class="fu">register_dopar_cmq</span>(<span class="at">n_jobs=</span><span class="dv">2</span>, <span class="at">memory=</span><span class="dv">1024</span>)</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="fu">register</span>(<span class="fu">DoparParam</span>())</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="fu">bplapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, sqrt)</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="co">#&gt; Running sequentially (&#39;LOCAL&#39;) ...</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="co">#&gt; [[1]]</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="co">#&gt; [1] 1</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a><span class="co">#&gt; [[2]]</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a><span class="co">#&gt; [1] 1.414214</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a><span class="co">#&gt; [[3]]</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a><span class="co">#&gt; [1] 1.732051</span></span></code></pre></div>
</div>
<div id="with-targets" class="section level3">
<h3>With <code>targets</code></h3>
<p>The <a href="https://github.com/ropensci/targets"><code>targets</code></a>
package enables users to define a dependency structure of different
function calls, and only evaluate them if the underlying data
changed.</p>
<blockquote>
<p>The <code>targets</code> package is a <a href="https://www.gnu.org/software/make/">Make</a>-like pipeline tool
for statistics and data science in R. The package skips costly runtime
for tasks that are already up to date, orchestrates the necessary
computation with implicit parallel computing, and abstracts files as R
objects. If all the current output matches the current upstream code and
data, then the whole pipeline is up to date, and the results are more
trustworthy than otherwise.</p>
</blockquote>
<p>It can use <code>clustermq</code> to <a href="https://books.ropensci.org/targets/hpc.html#clustermq">perform
calculations as jobs</a>.</p>
</div>
</div>
<div id="options" class="section level2">
<h2>Options</h2>
<p>The various configurable options are mentioned throughout the
documentation, where applicable, however, we list all of the options
here for reference.</p>
<p>Options can be set by including a call to
<code>options(&lt;key&gt; = &lt;value&gt;)</code> in your current
session or added as a line to your <code>~/.Rprofile</code>. The former
will only be available in your active session, while the latter will be
available any time after you restart R.</p>
<ul>
<li><code>clustermq.scheduler</code> - One of the supported <a href="#configuration"><code>clustermq</code> schedulers</a>; options are
<code>&quot;LOCAL&quot;</code>, <code>&quot;multiprocess&quot;</code>,
<code>&quot;multicore&quot;</code>, <code>&quot;lsf&quot;</code>, <code>&quot;sge&quot;</code>,
<code>&quot;slurm&quot;</code>, <code>&quot;pbs&quot;</code>, <code>&quot;Torque&quot;</code>, or
<code>&quot;ssh&quot;</code> (default is the HPC scheduler found in
<code>$PATH</code>, otherwise <code>&quot;LOCAL&quot;</code>)</li>
<li><code>clustermq.host</code> - The name of the node or device for
constructing the <code>ZeroMQ</code> host address (default is
<code>Sys.info()[&quot;nodename&quot;]</code>)</li>
<li><code>clustermq.ports</code> - A port range used by
<code>clustermq</code> to initiate connections. (default:
<code>6000:9999</code>) Important: This option - when used with the ssh
connector - must be set as an option on the remote host.</li>
<li><code>clustermq.ssh.host</code> - The user name and host for <a href="#ssh-connector">connecting to the HPC via SSH</a>
(e.g. <code>user@host</code>); we recommend setting up SSH keys for
password-less login</li>
<li><code>clustermq.ssh.log</code> - Path for a file (on the SSH host)
that will be created and populated with logging information regarding
the SSH connection (e.g. <code>&quot;~/cmq_ssh.log&quot;</code>); helpful for
debugging purposes</li>
<li><code>clustermq.ssh.timeout</code> - The amount of time to wait (in
seconds) for a SSH start-up connection before timing out (default is
<code>10</code> seconds)</li>
<li><code>clustermq.ssh.hpc_fwd_port</code> - Port that will be opened
for SSH reverse tunneling between the workers on the HPC and a local
session. Can also be specified as a port range that clustermq will
sample from. (default: one integer randomly sampled from the range
between 50000 and 55000)</li>
<li><code>clustermq.worker.timeout</code> - The amount of time to wait
(in seconds) for master-worker communication before timing out (default
is to wait indefinitely)</li>
<li><code>clustermq.template</code> - Path to a <a href="#scheduler-templates">template file</a> for submitting HPC jobs;
only necessary if using your own template, otherwise the default
template will be used (default depends on set or inferred
<code>clustermq.scheduler</code>)</li>
<li><code>clustermq.data.warning</code> - The threshold for the size of
the common data (in Mb) before <code>clustermq</code> throws a warning
(default is <code>1000</code>)</li>
<li><code>clustermq.defaults</code> - A named-list of default values for
the HPC template; this takes precedence over defaults specified in the
template file (default is an empty list)</li>
</ul>
</div>
<div id="debugging-workers" class="section level2">
<h2>Debugging workers</h2>
<p>Function calls evaluated by workers are wrapped in event handlers,
which means that even if a call evaluation throws an error, this should
be reported back to the main R session.</p>
<p>However, there are reasons why workers might crash, and in which case
they can not report back. These include:</p>
<ul>
<li>A segfault in a low-level process</li>
<li>Process kill due to resource constraints (e.g. walltime)</li>
<li>Reaching the wait timeout without any signal from the master
process</li>
<li>Probably others</li>
</ul>
<p>In this case, it is useful to have the worker(s) create a log file
that will also include events that are not reported back. It can be
requested using:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">Q</span>(..., <span class="at">log_worker=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<p>This will create a file called
<em>&lt;cmq_id&gt;-&lt;array_index&gt;.log</em> in your current working
directory, irrespective of which scheduler you use.</p>
<p>You can customize the file name using</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="fu">Q</span>(..., <span class="at">template=</span><span class="fu">list</span>(<span class="at">log_file =</span> <span class="sc">&lt;</span>yourlog<span class="sc">&gt;</span>))</span></code></pre></div>
<p>Note that in this case <code>log_file</code> is a template field of
your scheduler script, and hence needs to be present there in order for
this to work. The default templates all have this field included.</p>
<p>In order to log each worker separately, some schedulers support
wildcards in their log file names. For instance:</p>
<ul>
<li>Multicore/Multiprocess:
<code>log_file=&quot;/path/to.file.%i&quot;</code></li>
<li>SGE: <code>log_file=&quot;/path/to.file.$TASK_ID&quot;</code></li>
<li>LSF: <code>log_file=&quot;/path/to.file.%I&quot;</code></li>
<li>Slurm: <code>log_file=&quot;/path/to.file.%a&quot;</code></li>
<li>PBS: <code>log_file=&quot;/path/to.file.$PBS_ARRAY_INDEX&quot;</code></li>
<li>Torque: <code>log_file=&quot;/path/to.file.$PBS_ARRAYID&quot;</code></li>
</ul>
<p>Your scheduler documentation will have more details about the
available options.</p>
<p>When reporting a bug that includes worker crashes, please always
include a log file.</p>
</div>
<div id="environments" class="section level2">
<h2>Environments</h2>
<p>In some cases, it may be necessary to activate a specific computing
environment on the scheduler jobs prior to starting up the worker. This
can be, for instance, because <em>R</em> was only installed in a
specific environment or container.</p>
<p>Examples for such environments or containers are:</p>
<ul>
<li><a href="https://modules.sourceforge.net/">Bash module</a>
environments</li>
<li><a href="https://docs.conda.io/">Conda</a> environments</li>
<li><a href="https://www.docker.com/">Docker</a>/<a href="https://singularity.lbl.gov/">Singularity</a> containers</li>
</ul>
<p>It should be possible to activate them in the job submission script
(i.e., the template file). This is widely untested, but would look the
following for the <a href="#lsf">LSF</a> scheduler (analogous for
others):</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co">#BSUB-J {{ job_name }}[1-{{ n_jobs }}]  # name of the job / array jobs</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="co">#BSUB-o {{ log_file | /dev/null }}      # stdout + stderr</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="co">#BSUB-M {{ memory | 4096 }}             # Memory requirements in Mbytes</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co">#BSUB-R rusage[mem={{ memory | 4096 }}] # Memory requirements in Mbytes</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="co">##BSUB-q default                        # name of the queue (uncomment)</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="co">##BSUB-W {{ walltime | 6:00 }}          # walltime (uncomment)</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="ex">module</span> load {{ bashenv <span class="kw">|</span> <span class="ex">default_bash_env</span> }}</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="co"># or: source activate {{ conda | default_conda_env_name }}</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="co"># or: your environment activation command</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="bu">ulimit</span> <span class="at">-v</span> <span class="va">$((</span> <span class="dv">1024</span> <span class="op">*</span> <span class="er">{{</span> <span class="va">memory</span> <span class="op">|</span> <span class="dv">4096</span> }} <span class="va">))</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a><span class="va">CMQ_AUTH</span><span class="op">=</span>{{ <span class="ex">auth</span> }} R <span class="at">--no-save</span> <span class="at">--no-restore</span> <span class="at">-e</span> <span class="st">&#39;clustermq:::worker(&quot;{{ master }}&quot;)&#39;</span></span></code></pre></div>
<p>This template still needs to be filled, so in the above example you
need to pass either</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="fu">Q</span>(..., <span class="at">template=</span><span class="fu">list</span>(<span class="at">bashenv=</span><span class="st">&quot;my environment name&quot;</span>))</span></code></pre></div>
<p>or set it via an option:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="fu">options</span>(</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>    <span class="at">clustermq.defaults =</span> <span class="fu">list</span>(<span class="at">bashenv=</span><span class="st">&quot;my default env&quot;</span>)</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="scheduler-templates" class="section level2">
<h2>Scheduler templates</h2>
<p>The package provides its own default scheduler templates, similar to
the ones listed below. Which template is used is decided based on which
scheduler submission executable is present in the user’s
<code>$PATH</code>, e.g. <code>sbatch</code> for SLURM or
<code>bsub</code> for LSF. <code>qsub</code> is ambiguous between SGE
and PBS/Torque, so in this case
<code>options(clustermq.scheduler = &quot;&lt;opt&gt;&quot;)</code> should be set
to the correct one.</p>
<p>A user can provide their own template file via
<code>options(clustermq.template = &quot;&lt;file&gt;&quot;)</code>, containing
arbitrary template values <code>{{ value | default }}</code>. These
values will be filled upon job submission in the following order of
priority:</p>
<ol style="list-style-type: decimal">
<li>The argument provided to
<code>Q(..., template=list(key = value))</code> or
<code>workers(... template=list(key = value))</code></li>
<li>The value of <code>getOption(&quot;clustermq.defaults&quot;)</code></li>
<li>The default value inside the template</li>
</ol>
<div id="lsf" class="section level3">
<h3>LSF</h3>
<p>Set the following options in your <em>R</em> session that will submit
jobs:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="fu">options</span>(</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>    <span class="at">clustermq.scheduler =</span> <span class="st">&quot;lsf&quot;</span>,</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>    <span class="at">clustermq.template =</span> <span class="st">&quot;/path/to/file/below&quot;</span> <span class="co"># if using your own template</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>)</span></code></pre></div>
<p>To supply your own template, save the contents below with any desired
changes to a file and have <code>clustermq.template</code> point to
it.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co">#BSUB-J {{ job_name }}[1-{{ n_jobs }}]  # name of the job / array jobs</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="co">#BSUB-n {{ cores | 1 }}                 # number of cores to use per job</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="co">#BSUB-o {{ log_file | /dev/null }}      # stdout + stderr; %I for array index</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="co">#BSUB-M {{ memory | 4096 }}             # Memory requirements in Mbytes</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a><span class="co">#BSUB-R rusage[mem={{ memory | 4096 }}] # Memory requirements in Mbytes</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a><span class="co">##BSUB-q default                        # name of the queue (uncomment)</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="co">##BSUB-W {{ walltime | 6:00 }}          # walltime (uncomment)</span></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a><span class="bu">ulimit</span> <span class="at">-v</span> <span class="va">$((</span> <span class="dv">1024</span> <span class="op">*</span> <span class="er">{{</span> <span class="va">memory</span> <span class="op">|</span> <span class="dv">4096</span> }} <span class="va">))</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a><span class="va">CMQ_AUTH</span><span class="op">=</span>{{ <span class="ex">auth</span> }} R <span class="at">--no-save</span> <span class="at">--no-restore</span> <span class="at">-e</span> <span class="st">&#39;clustermq:::worker(&quot;{{ master }}&quot;)&#39;</span></span></code></pre></div>
<p>In this file, <code>#BSUB-*</code> defines command-line arguments to
the <code>bsub</code> program.</p>
<ul>
<li>Memory: defined by <code>BSUB-M</code> and <code>BSUB-R</code>.
Check your local setup if the memory values supplied are MiB or KiB,
default is <code>4096</code> if not requesting memory when calling
<code>Q()</code></li>
<li>Queue: <code>BSUB-q default</code>. Use the queue with name
<em>default</em>. This will most likely not exist on your system, so
choose the right name and uncomment by removing the additional
<code>#</code></li>
<li>Walltime: <code>BSUB-W {{ walltime }}</code>. Set the maximum time a
job is allowed to run before being killed. The default here is to
disable this line. If you enable it, enter a fixed value or pass the
<code>walltime</code> argument to each function call. The way it is
written, it will use 6 hours if no arguemnt is given.</li>
<li>For other options, see <a href="https://www.ibm.com/docs/en/spectrum-lsf/10.1.0?topic=bsub-options">the
LSF documentation</a> and add them via <code>#BSUB-*</code> (where
<code>*</code> represents the argument)</li>
<li>Do not change the identifiers in curly braces
(<code>{{ ... }}</code>), as they are used to fill in the right
variables</li>
</ul>
<p>Once this is done, the package will use your settings and no longer
warn you of the missing options.</p>
</div>
<div id="sge" class="section level3">
<h3>SGE</h3>
<p>Set the following options in your <em>R</em> session that will submit
jobs:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="fu">options</span>(</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>    <span class="at">clustermq.scheduler =</span> <span class="st">&quot;sge&quot;</span>,</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>    <span class="at">clustermq.template =</span> <span class="st">&quot;/path/to/file/below&quot;</span> <span class="co"># if using your own template</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>)</span></code></pre></div>
<p>To supply your own template, save the contents below with any desired
changes to a file and have <code>clustermq.template</code> point to
it.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co">#$ -N {{ job_name }}               # job name</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="co">##$ -q default                      # submit to queue named &quot;default&quot;</span></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a><span class="co">#$ -j y                            # combine stdout/error in one file</span></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a><span class="co">#$ -o {{ log_file | /dev/null }}   # output file</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="co">#$ -cwd                            # use pwd as work dir</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a><span class="co">#$ -V                              # use environment variable</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a><span class="co">#$ -t 1-{{ n_jobs }}               # submit jobs as array</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a><span class="co">#$ -pe smp {{ cores | 1 }}         # number of cores to use per job</span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a><span class="co">#$ -l m_mem_free={{ memory | 1073741824 }} # 1 Gb in bytes</span></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a><span class="bu">ulimit</span> <span class="at">-v</span> <span class="va">$((</span> <span class="dv">1024</span> <span class="op">*</span> <span class="er">{{</span> <span class="va">memory</span> <span class="op">|</span> <span class="dv">4096</span> }} <span class="va">))</span></span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a><span class="va">CMQ_AUTH</span><span class="op">=</span>{{ <span class="ex">auth</span> }} R <span class="at">--no-save</span> <span class="at">--no-restore</span> <span class="at">-e</span> <span class="st">&#39;clustermq:::worker(&quot;{{ master }}&quot;)&#39;</span></span></code></pre></div>
<p>In this file, <code>#$-*</code> defines command-line arguments to the
<code>qsub</code> program.</p>
<ul>
<li>Queue: <code>$ -q default</code>. Use the queue with name
<em>default</em>. This will most likely not exist on your system, so
choose the right name and uncomment by removing the additional
<code>#</code></li>
<li>For other options, see <a href="https://gridscheduler.sourceforge.net/htmlman/manuals.html">the
SGE documentation</a>. Do not change the identifiers in curly braces
(<code>{{ ... }}</code>), as they are used to fill in the right
variables.</li>
</ul>
<p>Once this is done, the package will use your settings and no longer
warn you of the missing options.</p>
</div>
<div id="slurm" class="section level3">
<h3>SLURM</h3>
<p>Set the following options in your <em>R</em> session that will submit
jobs:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="fu">options</span>(</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>    <span class="at">clustermq.scheduler =</span> <span class="st">&quot;slurm&quot;</span>,</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>    <span class="at">clustermq.template =</span> <span class="st">&quot;/path/to/file/below&quot;</span> <span class="co"># if using your own template</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>)</span></code></pre></div>
<p>To supply your own template, save the contents below with any desired
changes to a file and have <code>clustermq.template</code> point to
it.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="co">#SBATCH --job-name={{ job_name }}</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="co">##SBATCH --partition=default</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="co">#SBATCH --output={{ log_file | /dev/null }}</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a><span class="co">#SBATCH --error={{ log_file | /dev/null }}</span></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a><span class="co">#SBATCH --mem-per-cpu={{ memory | 4096 }}</span></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a><span class="co">#SBATCH --array=1-{{ n_jobs }}</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task={{ cores | 1 }}</span></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a><span class="bu">ulimit</span> <span class="at">-v</span> <span class="va">$((</span> <span class="dv">1024</span> <span class="op">*</span> <span class="er">{{</span> <span class="va">memory</span> <span class="op">|</span> <span class="dv">4096</span> }} <span class="va">))</span></span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a><span class="va">CMQ_AUTH</span><span class="op">=</span>{{ <span class="ex">auth</span> }} R <span class="at">--no-save</span> <span class="at">--no-restore</span> <span class="at">-e</span> <span class="st">&#39;clustermq:::worker(&quot;{{ master }}&quot;)&#39;</span></span></code></pre></div>
<p>In this file, <code>#SBATCH</code> defines command-line arguments to
the <code>sbatch</code> program.</p>
<ul>
<li>Partition: <code>SBATCH --partition default</code>. Use the queue
with name <em>default</em>. This will most likely not exist on your
system, so choose the right name and uncomment by removing the
additional <code>#</code></li>
<li>For other options, see <a href="https://slurm.schedmd.com/sbatch.html">the SLURM
documentation</a>. Do not change the identifiers in curly braces
(<code>{{ ... }}</code>), as they are used to fill in the right
variables.</li>
</ul>
<p>Once this is done, the package will use your settings and no longer
warn you of the missing options.</p>
</div>
<div id="pbs" class="section level3">
<h3>PBS</h3>
<p>Set the following options in your <em>R</em> session that will submit
jobs:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="fu">options</span>(</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>    <span class="at">clustermq.scheduler =</span> <span class="st">&quot;pbs&quot;</span>,</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>    <span class="at">clustermq.template =</span> <span class="st">&quot;/path/to/file/below&quot;</span> <span class="co"># if using your own template</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>)</span></code></pre></div>
<p>To supply your own template, save the contents below with any desired
changes to a file and have <code>clustermq.template</code> point to
it.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co">#PBS -N {{ job_name }}</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="co">#PBS -J 1-{{ n_jobs }}</span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="co">#PBS -l select=1:ncpus={{ cores | 1 }}:mpiprocs={{ cores | 1 }}:mem={{ memory | 4096 }}MB</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="co">#PBS -l walltime={{ walltime | 12:00:00 }}</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a><span class="co">#PBS -o {{ log_file | /dev/null }}</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="co">#PBS -j oe</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="co">##PBS -q default</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a><span class="bu">ulimit</span> <span class="at">-v</span> <span class="va">$((</span> <span class="dv">1024</span> <span class="op">*</span> <span class="er">{{</span> <span class="va">memory</span> <span class="op">|</span> <span class="dv">4096</span> }} <span class="va">))</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a><span class="va">CMQ_AUTH</span><span class="op">=</span>{{ <span class="ex">auth</span> }} R <span class="at">--no-save</span> <span class="at">--no-restore</span> <span class="at">-e</span> <span class="st">&#39;clustermq:::worker(&quot;{{ master }}&quot;)&#39;</span></span></code></pre></div>
<p>In this file, <code>#PBS-*</code> defines command-line arguments to
the <code>qsub</code> program.</p>
<ul>
<li>Queue: <code>#PBS-q default</code>. Use the queue with name
<em>default</em>. This will most likely not exist on your system, so
choose the right name and uncomment by removing the additional
<code>#</code></li>
<li>For other options, see the PBS documentation. Do not change the
identifiers in curly braces (<code>{{ ... }}</code>), as they are used
to fill in the right variables.</li>
</ul>
<p>Once this is done, the package will use your settings and no longer
warn you of the missing options.</p>
</div>
<div id="torque" class="section level3">
<h3>Torque</h3>
<p>Set the following options in your <em>R</em> session that will submit
jobs:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="fu">options</span>(</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>    <span class="at">clustermq.scheduler =</span> <span class="st">&quot;Torque&quot;</span>,</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>    <span class="at">clustermq.template =</span> <span class="st">&quot;/path/to/file/below&quot;</span> <span class="co"># if using your own template</span></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>)</span></code></pre></div>
<p>To supply your own template, save the contents below with any desired
changes to a file and have <code>clustermq.template</code> point to
it.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="co">#PBS -N {{ job_name }}</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="co">#PBS -l nodes={{ n_jobs }}:ppn={{ cores | 1 }},walltime={{ walltime | 12:00:00 }}</span></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a><span class="co">#PBS -o {{ log_file | /dev/null }}</span></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="co">#PBS -j oe</span></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a><span class="co">##PBS -q default</span></span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a><span class="bu">ulimit</span> <span class="at">-v</span> <span class="va">$((</span> <span class="dv">1024</span> <span class="op">*</span> <span class="er">{{</span> <span class="va">memory</span> <span class="op">|</span> <span class="dv">4096</span> }} <span class="va">))</span></span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a><span class="va">CMQ_AUTH</span><span class="op">=</span>{{ <span class="ex">auth</span> }} R <span class="at">--no-save</span> <span class="at">--no-restore</span> <span class="at">-e</span> <span class="st">&#39;clustermq:::worker(&quot;{{ master }}&quot;)&#39;</span></span></code></pre></div>
<p>In this file, <code>#PBS-*</code> defines command-line arguments to
the <code>qsub</code> program.</p>
<ul>
<li>Queue: <code>#PBS-q default</code>. Use the queue with name
<em>default</em>. This will most likely not exist on your system, so
choose the right name and uncomment by removing the additional
<code>#</code></li>
<li>For other options, see the Torque documentation. Do not change the
identifiers in curly braces (<code>{{ ... }}</code>), as they are used
to fill in the right variables.</li>
</ul>
<p>Once this is done, the package will use your settings and no longer
warn you of the missing options.</p>
</div>
<div id="ssh-template" class="section level3">
<h3>SSH</h3>
<p>While SSH is not a scheduler, we can access remote schedulers via
SSH. If you want to use it, first make sure that <code>clustermq</code>
works on your server with the real scheduler. Only then move on to
setting up SSH.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="fu">options</span>(</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>    <span class="at">clustermq.scheduler =</span> <span class="st">&quot;ssh&quot;</span>,</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>    <span class="at">clustermq.ssh.host =</span> <span class="st">&quot;myhost&quot;</span>, <span class="co"># set this up in your local ~/.ssh/config</span></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>    <span class="at">clustermq.ssh.log =</span> <span class="st">&quot;~/ssh_proxy.log&quot;</span>,     <span class="co"># log file on your HPC</span></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>    <span class="at">clustermq.ssh.timeout =</span> <span class="dv">30</span>,    <span class="co"># if changing default connection timeout</span></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>    <span class="at">clustermq.template =</span> <span class="st">&quot;/path/to/file/below&quot;</span> <span class="co"># if using your own template</span></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>)</span></code></pre></div>
<p>The default template is shown below. If <code>R</code> is not in your
HPC <code>$PATH</code>, you may need to specify its path or <a href="https://github.com/mschubert/clustermq/issues/281">load the
required bash modules/conda environments</a>.</p>
<p>To supply your own template, save its contents with any desired
changes to a file <em>on your local machine</em> and have
<code>clustermq.template</code> point to it.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-o</span> <span class="st">&quot;ExitOnForwardFailure yes&quot;</span> <span class="at">-f</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>    <span class="ex">-R</span> {{ ctl_port }}:localhost:{{ local_port }}</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>    <span class="ex">-R</span> {{ job_port }}:localhost:{{ fwd_port }}</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a>    <span class="ex">{{</span> ssh_host }}</span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>    <span class="st">&quot;R --no-save --no-restore -e</span></span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a><span class="st">        &#39;clustermq:::ssh_proxy(ctl={{ ctl_port }}, job={{ job_port }})&#39;</span></span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a><span class="st">        &gt; {{ ssh_log | /dev/null }} 2&gt;&amp;1&quot;</span></span></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
