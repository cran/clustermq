<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Michael Schubert" />

<meta name="date" content="2017-11-30" />

<title>ClusterMQ: send R function calls as cluster jobs</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
a.sourceLine { display: inline-block; min-height: 1.25em; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; }
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em; }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; color: #aaaaaa;  padding-left: 4px; }
@media screen {
a.sourceLine::before { text-decoration: underline; color: initial; }
}
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.bn { color: #40a070; } /* BaseN */
code span.fl { color: #40a070; } /* Float */
code span.ch { color: #4070a0; } /* Char */
code span.st { color: #4070a0; } /* String */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.ot { color: #007020; } /* Other */
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.fu { color: #06287e; } /* Function */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code span.cn { color: #880000; } /* Constant */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.ss { color: #bb6688; } /* SpecialString */
code span.im { } /* Import */
code span.va { color: #19177c; } /* Variable */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.op { color: #666666; } /* Operator */
code span.bu { } /* BuiltIn */
code span.ex { } /* Extension */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.at { color: #7d9029; } /* Attribute */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>

</head>

<body>




<h1 class="title toc-ignore">ClusterMQ: send R function calls as cluster jobs</h1>
<h4 class="author"><em>Michael Schubert</em></h4>
<h4 class="date"><em>2017-11-30</em></h4>



<p>This package will allow you to send function calls as cluster jobs (using <a href="https://github.com/mschubert/clustermq/wiki/LSF">LSF</a>, <a href="https://github.com/mschubert/clustermq/wiki/SGE">SGE</a> or <a href="https://github.com/mschubert/clustermq/wiki/SLURM">SLURM</a>) using a minimal interface provided by the <code>Q</code> function:</p>
<pre class="sourceCode r" id="cb1"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># load the library and create a simple function</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(clustermq)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">fx =<span class="st"> </span><span class="cf">function</span>(x) x <span class="op">*</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co"># queue the function call </span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw">Q</span>(fx, <span class="dt">x=</span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">n_jobs=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="co"># list(2,4,6)</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="co"># this will submit a cluster job that connects to the master via TCP</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="co"># the master will then send the function and argument chunks to the worker</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="co"># and the worker will return the results to the master</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="co"># until everything is done and you get back your result</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="co"># we can also use dplyr's mutate to modify data frames</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb1-17" data-line-number="17">iris <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">area =</span> <span class="kw">Q</span>(<span class="st">`</span><span class="dt">*</span><span class="st">`</span>, <span class="dt">e1=</span>Sepal.Length, <span class="dt">e2=</span>Sepal.Width, <span class="dt">n_jobs=</span><span class="dv">1</span>))</a></code></pre>
<p>Computations are done <a href="https://github.com/armstrtw/rzmq">entirely on the network</a> and without any temporary files on network-mounted storage, so there is no strain on the file system apart from starting up R once per job. This removes the biggest bottleneck in distributed computing.</p>
<p>Using this approach, we can easily do load-balancing, i.e. workers that get their jobs done faster will also receive more function calls to work on. This is especially useful if not all calls return after the same time, or one worker has a high load.</p>
<section id="installation" class="level2">
<h2>Installation</h2>
<p>First, we need the <a href="https://github.com/ropensci/rzmq#installation">ZeroMQ</a> system library. Most likely, your package manager will provide this:</p>
<pre class="sourceCode sh" id="cb2"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="ex">brew</span> install zeromq <span class="co"># homebrew on OS-X</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="fu">sudo</span> apt-get install libzmq3-dev <span class="co"># ubuntu</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="fu">sudo</span> yum install zeromq3-devel <span class="co"># fedora</span></a></code></pre>
<p>The package on CRAN should be relatively up-to-date. You can install it using:</p>
<pre class="sourceCode r" id="cb3"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">install.packages</span>(<span class="st">'clustermq'</span>)</a></code></pre>
<p>Alternatively, you can get the latest version from <a href="https://github.com/mschubert/clustermq">Github</a>:</p>
<pre class="sourceCode r" id="cb4"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># install.packages('devtools')</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">'mschubert/clustermq'</span>, <span class="dt">ref=</span><span class="st">&quot;develop&quot;</span>)</a></code></pre>
</section>
<section id="setting-up-the-scheduler" class="level2">
<h2>Setting up the scheduler</h2>
<p>An HPC cluster’s scheduler ensures that computing jobs are distributed to available worker nodes. Hence, this is what <code>clustermq</code> interfaces with in order to do computations. See the links below to set up the respective schedulers.</p>
<ul>
<li><a href="https://github.com/mschubert/clustermq/wiki/LSF">LSF</a></li>
<li><a href="https://github.com/mschubert/clustermq/wiki/SGE">SGE</a></li>
<li><a href="https://github.com/mschubert/clustermq/wiki/SLURM">SLURM</a></li>
<li>if you want another scheduler, <a href="https://github.com/mschubert/clustermq/issues/new">open an issue</a></li>
</ul>
<p>You can also use the schedulers above <a href="SSH">from your local machine via SSH</a>.</p>
</section>
<section id="examples" class="level2">
<h2>Examples</h2>
<p>The package is designed to distribute arbitrary function calls on HPC worker nodes. There are, however, a couple of caveats to observe as the R session running on a worker does not share your local memory.</p>
<p>The simplest example is to a function call that is completely self-sufficient, and there is one argument (<code>x</code>) that we iterate through:</p>
<pre class="sourceCode r" id="cb5"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">fx =<span class="st"> </span><span class="cf">function</span>(x) x <span class="op">*</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw">Q</span>(fx, <span class="dt">x=</span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">n_jobs=</span><span class="dv">1</span>)</a></code></pre>
<pre><code>## Submitting 1 worker jobs (ID: 7557) ...</code></pre>
<pre><code>## [[1]]
## [1] 2
## 
## [[2]]
## [1] 4
## 
## [[3]]
## [1] 6</code></pre>
<p>Non-iterated arguments are supported by the <code>const</code> argument:</p>
<pre class="sourceCode r" id="cb8"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">fx =<span class="st"> </span><span class="cf">function</span>(x, y) x <span class="op">*</span><span class="st"> </span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="kw">Q</span>(fx, <span class="dt">x=</span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">const=</span><span class="kw">list</span>(<span class="dt">y=</span><span class="dv">10</span>), <span class="dt">n_jobs=</span><span class="dv">1</span>)</a></code></pre>
<pre><code>## Submitting 1 worker jobs (ID: 6855) ...</code></pre>
<pre><code>## [[1]]
## [1] 12
## 
## [[2]]
## [1] 14
## 
## [[3]]
## [1] 16</code></pre>
<p>If a function relies on objects in its environment that are not passed as arguments, they can be exported using the <code>export</code> argument:</p>
<pre class="sourceCode r" id="cb11"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">fx =<span class="st"> </span><span class="cf">function</span>(x) x <span class="op">*</span><span class="st"> </span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw">Q</span>(fx, <span class="dt">x=</span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">export=</span><span class="kw">list</span>(<span class="dt">y=</span><span class="dv">10</span>), <span class="dt">n_jobs=</span><span class="dv">1</span>)</a></code></pre>
<pre><code>## Submitting 1 worker jobs (ID: 7140) ...</code></pre>
<pre><code>## [[1]]
## [1] 12
## 
## [[2]]
## [1] 14
## 
## [[3]]
## [1] 16</code></pre>
<p>Finally, if we want to use a package function we need to load it on the worker using a <code>library()</code> call or referencing it with <code>package_name::</code>:</p>
<pre class="sourceCode r" id="cb14"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">fx =<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">    <span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">    x <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="st">        </span><span class="kw">mutate</span>(<span class="dt">area =</span> Sepal.Length <span class="op">*</span>Sepal.Width) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="st">        </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="kw">Q</span>(fx, <span class="dt">x=</span><span class="kw">list</span>(iris), <span class="dt">n_jobs=</span><span class="dv">1</span>)</a></code></pre>
<pre><code>## Submitting 1 worker jobs (ID: 6776) ...</code></pre>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<pre><code>## [[1]]
##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species  area
## 1          5.1         3.5          1.4         0.2  setosa 17.85
## 2          4.9         3.0          1.4         0.2  setosa 14.70
## 3          4.7         3.2          1.3         0.2  setosa 15.04
## 4          4.6         3.1          1.5         0.2  setosa 14.26
## 5          5.0         3.6          1.4         0.2  setosa 18.00
## 6          5.4         3.9          1.7         0.4  setosa 21.06</code></pre>
</section>
<section id="usage" class="level2">
<h2>Usage</h2>
<p>The following arguments are supported by <code>Q</code>:</p>
<ul>
<li><code>fun</code> - The function to call. This needs to be self-sufficient (because it will not have access to the <code>master</code> environment)</li>
<li><code>...</code> - All iterated arguments passed to the function. If there is more than one, all of them need to be named</li>
<li><code>const</code> - A named list of non-iterated arguments passed to <code>fun</code></li>
</ul>
<p>Behavior can further be fine-tuned using the options below:</p>
<ul>
<li><code>fail_on_error</code> - Whether to stop if one of the calls returns an error</li>
<li><code>seed</code> - A common seed that is combined with job number for reproducible results</li>
<li><code>memory</code> - Amount of memory to request for the job (<code>bsub -M</code>)</li>
<li><code>n_jobs</code> - Number of jobs to submit for all the function calls</li>
<li><code>job_size</code> - Number of function calls per job. If used in combination with <code>n_jobs</code> the latter will be overall limit</li>
<li><code>chunk_size</code> - How many calls a worker should process before reporting back to the master. Default: every worker will report back 100 times total</li>
<li><code>wait_time</code> - How long the master should wait between checking for results</li>
</ul>
</section>
<section id="comparison-to-other-packages" class="level2">
<h2>Comparison to other packages</h2>
<p>There are some packages that provide high-level parallelization of R function calls on a computing cluster. A thorough comparison of features and performance is available <a href="https://github.com/mschubert/clustermq/wiki#comparison-to-other-packages">on the wiki</a>.</p>
<p>In short, use <code>ClusterMQ</code> if you want:</p>
<ul>
<li>a one-line solution to run cluster jobs with minimal setup</li>
<li>access cluster functions from your local Rstudio</li>
<li>network storage I/O is a problem for you(r cluster)</li>
<li>your function calls or some workers are (much) slower than others</li>
</ul>
<p>Use <a href="https://github.com/mllg/batchtools"><code>batchtools</code></a> if:</p>
<ul>
<li>you want more control over how your jobs are run</li>
<li>don’t mind a few extra lines to register and schedule your jobs</li>
</ul>
<p>Use <a href="https://github.com/sahilseth/flowr"><code>flowr</code></a>, <a href="https://github.com/richfitz/remake"><code>remake</code></a> or <a href="https://snakemake.readthedocs.io/en/latest/">Snakemake</a> if:</p>
<ul>
<li>you want to design and run a pipeline of different tools</li>
</ul>
<p>Don’t use <a href="https://cran.r-project.org/package=batch"><code>batch</code></a> (last updated 2013) or <a href="https://github.com/tudo-r/BatchJobs"><code>BatchJobs</code></a> (issues with SQLite on network-mounted storage).</p>
</section>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
